services:
  codex-dist-builder: &codex-dist-builder
    image: docker.io/ajslater/codex-dist-builder:$CODEX_DIST_BUILDER_VERSION
  codex-backend-lint:
    <<: *codex-dist-builder
    container_name: codex-backend-lint
    command: make lint-backend
  codex-frontend-lint:
    <<: *codex-dist-builder
    container_name: codex-frontend-lint
    command: make lint-frontend
  codex-frontend-test:
    <<: *codex-dist-builder
    container_name: codex-frontend-test
    command: make test-frontend
    volumes:
      - ./frontend/src/choices:/app/frontend/src/choices
      - ./test-results/:/app/test-results/
  codex-frontend-build:
    <<: *codex-dist-builder
    container_name: codex-frontend-build
    volumes:
      - ./frontend/src/choices:/app/frontend/src/choices:ro
      - ./codex/static_build:/app/codex/static_build
    command: make build-frontend -o build-choices
  codex-backend-test:
    <<: *codex-dist-builder
    container_name: codex-backend-test
    volumes:
      - ./codex/static_build:/app/codex/static_build:ro
      - ./codex/static_root:/app/codex/static_root
    command: make test-backend -o build-frontend
  codex-build-dist:
    <<: *codex-dist-builder
    container_name: codex-build-dist
    volumes:
      - ./codex/static_root:/app/codex/static_root:ro
      - ./dist/:/app/dist/
    command: make build-backend -o collectstatic
  codex:
    build:
      context: .
      dockerfile: ci/Dockerfile
    image: docker.io/ajslater/codex
    container_name: codex
    ports:
      - "9810:9810"
    volumes:
      - ./config:/config
      - ./comics:/comics:ro
  codex-dev:
    build:
      context: .
      dockerfile: ci/dev.Dockerfile
    image: codex-dev
    # mem_limit: 1g
    container_name: codex-dev
    environment:
      - VITE_HOST=localhost
    ports:
      - "9810:9810"
    volumes:
      - .:/app
      - ./comics:/comics
    # init: true
    command: tail -f /dev/null
  codex-package:
    build:
      context: .
      dockerfile: ci/package.Dockerfile
    image: codex-package
    container_name: codex-package
    env_file:
      - .env.package
    ports:
      - "9810:9810"
    volumes:
      - ./dist:/dist
      - ./comics:/comics
      - ./config:/config
  nginx:
    image: lscr.io/linuxserver/nginx
    container_name: nginx
    # network_mode: host
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.conf:/config/nginx/site-confs/default.conf:ro
